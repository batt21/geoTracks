<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mappa Strava + Tracce</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet">

  <!-- DataTables Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"/>
 
  <style>
    #map {
      height: 400px;
      width: 100%;
      margin-bottom: 20px;
    }
    /* Overlay con loader */
    #loader-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
    }
    #loader {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #e63946; /* rosso Strava */
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      margin: -30px 0 0 -30px;
    }
    @keyframes spin {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    a.show-track.active-track {
        color: #e63946 !important; /* rosso Strava */
        font-weight: bold;
        text-decoration: underline;
    }
    #activities-table th, 
    #activities-table td {
      max-width: 120px;
    }


  </style>
</head>
<body class="bg-light">

<div class="container-fluid p-3">
  <h1 class="mb-3 text-center">Strava Tracker</h1>

  <!-- Mappa -->
  <div class="d-flex">
  <div id="map" style="flex: 1; height: 400px;"></div>
  <div id="chart-container" style="flex: 1; height: 400px;"></div>
</div>

  <!-- Tabella attività -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Tracce</h5>
      <div class="mb-2 d-flex align-items-center">
  <label for="activityFilter" class="form-label me-2 mb-0">Filtra per tipo:</label>
  <select id="activityFilter" class="form-select w-auto">
    <option value="">Tutti</option>
    <option>AlpineSki</option>
    <option>BackcountrySki</option>
    <option>Badminton</option>
    <option>Canoeing</option>
    <option>Crossfit</option>
    <option>EBikeRide</option>
    <option>Elliptical</option>
    <option>EMountainBikeRide</option>
    <option>Golf</option>
    <option>GravelRide</option>
    <option>Handcycle</option>
    <option>HighIntensityIntervalTraining</option>
    <option>Hike</option>
    <option>IceSkate</option>
    <option>InlineSkate</option>
    <option>Kayaking</option>
    <option>Kitesurf</option>
    <option>MountainBikeRide</option>
    <option>NordicSki</option>
    <option>Pickleball</option>
    <option>Pilates</option>
    <option>Racquetball</option>
    <option>Ride</option>
    <option>RockClimbing</option>
    <option>RollerSki</option>
    <option>Rowing</option>
    <option>Run</option>
    <option>Sail</option>
    <option>Skateboard</option>
    <option>Snowboard</option>
    <option>Snowshoe</option>
    <option>Soccer</option>
    <option>Squash</option>
    <option>StairStepper</option>
    <option>StandUpPaddling</option>
    <option>Surfing</option>
    <option>Swim</option>
    <option>TableTennis</option>
    <option>Tennis</option>
    <option>TrailRun</option>
    <option>Velomobile</option>
    <option>VirtualRide</option>
    <option>VirtualRow</option>
    <option>VirtualRun</option>
    <option>Walk</option>
    <option>WeightTraining</option>
    <option>Wheelchair</option>
    <option>Windsurf</option>
    <option>Workout</option>
    <option>Yoga</option>
  </select>
</div>

</div>

      <div class="table-responsive card-body">
        <table id="activities-table" class="table table-sm table-striped table-bordered align-middle text-nowrap">
          <thead class="table-dark">
            <tr>
              <th>Nome</th>
              <th>Distanza (km)</th>
              <th>Tipo</th>
              <th>Data</th>
              <th>Durata (min)</th>
              <th>Velocità media (km/h)</th>
              <th>FC media (BPM)</th>
            </tr>
          </thead>
          <tbody>
            <!-- Le attività saranno inserite qui via jQuery -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Overlay loader -->
<div id="loader-overlay">
  <div id="loader"></div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Leaflet -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Polyline decoder di Leaflet -->
<script src="http://localhost/geoTracks/Polyline.encoded.js"></script>
<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>


<script>
$(document).ready(function () {
  var access_token = null;
  // all’avvio
    loadSavedActivities();
  const auth_link = "https://www.strava.com/oauth/token";
  var map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  var polylines = {};       // tutte le tracce salvate per ID
  var selectedPolyline = null; // traccia attualmente evidenziata

  // Loader overlay
  $(document).ajaxStart(function () {
    $("#loader-overlay").show();
  });
  $(document).ajaxStop(function () {
    $("#loader-overlay").hide();
  });

  var table = $('#activities-table').DataTable({
    language: {
      url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/it-IT.json'
    },
    pageLength: 10
  });
  
  $('#activityFilter').on('change', function () {
  const val = $(this).val();
  table.column(2) // colonna "Tipo"
       .search(val ? '^' + val + '$' : '', true, false)
       .draw();
});

    function saveActivities(activities) {
      const saved = JSON.parse(localStorage.getItem("savedActivities")) || [];
      const savedIds = saved.map(a => a.id);

      // filtra solo le nuove attività
      const newActivities = activities.filter(a => !savedIds.includes(a.id));

      if (newActivities.length > 0) {
        const updated = saved.concat(newActivities);
        localStorage.setItem("savedActivities", JSON.stringify(updated));
      }

      return newActivities;
    }
    
    function loadSavedActivities() {
  const saved = JSON.parse(localStorage.getItem("savedActivities")) || [];
  $.each(saved, function (index, activity) {
    // stesso codice che usi per disegnare polylines + popolare la tabella
  });
}




  function getActivities(res, page) {
    var per_page = 10;
    var activities_link =
      "https://www.strava.com/api/v3/athlete/activities?" +
      "access_token=" + res.access_token +
      "&per_page=" + per_page +
      "&page=" + page;
 
    $.getJSON(activities_link)
      .done(function (data) {
        if (data.length !== 0) {
            console.log(data);
          $.each(data, function (index, activity) {
        
            if (activity.map && activity.map.summary_polyline) {
              var coordinates = L.Polyline.fromEncoded(activity.map.summary_polyline).getLatLngs();
              var polyline = L.polyline(coordinates, {
                color: 'blue',
                weight: 2,
                opacity: 0.7,
                lineJoin: 'round'
              }).addTo(map);

              polylines[activity.id] = polyline;

              // Centra la mappa solo sulla prima attività
              if (page === 1 && index === 0) {
                map.fitBounds(polyline.getBounds());
              }
            }

            var distanceKm = (activity.distance / 1000).toFixed(2);
            var movingTimeMin = Math.round(activity.moving_time / 60);
            var d = new Date(activity.start_date_local);
            var type = activity.type;

            var startDate = d.getFullYear() + "-" + ("0" + (d.getMonth()+1)).slice(-2) + "-" + 
                            ("0"+d.getDate()).slice(-2) + " " + 
                            ("0" + d.getHours()).slice(-2) + ":" + ("0" + d.getMinutes()).slice(-2);

            var nameLink = `<a href="#" class="show-track" data-id="${activity.id}" data-date="${startDate}">${activity.name}</a>`;

            // velocità media
            var avgSpeed = activity.average_speed ? (activity.average_speed * 3.6).toFixed(1) : "-";

            // frequenza cardiaca media
            var avgHR = activity.average_heartrate ? activity.average_heartrate.toFixed(0) : "-";

            table.row.add([
              nameLink,
              distanceKm,
              type,
              startDate,
              movingTimeMin,
              avgSpeed,
              avgHR
            ]).draw(false);

          });

          getActivities(res, page + 1);
        }
      })
      .fail(function (jqXHR, textStatus, errorThrown) {
        console.error("Errore durante il caricamento delle attività:", textStatus, errorThrown);
        alert("Impossibile caricare le attività. Riprova più tardi.");
      });
  }
  
  function formatTime(seconds) {
    const totalMinutes = Math.floor(seconds / 60);
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return `${hours}:${minutes.toString().padStart(2,'0')}`;
}

  // Evento click sui link della tabella
  $('#activities-table tbody').on('click', 'a.show-track', function (e) {
    e.preventDefault();
    var id = $(this).data('id');

    if (polylines[id]) {
      
     // mostra solo la nuova traccia
      selectedPolyline = polylines[id];
      
            $.each(polylines, function(key, polyline){
                map.removeLayer(polyline);
            });
      

        map.fitBounds(selectedPolyline.getBounds());
 
      // evidenzia il link attivo
        $('a.show-track').removeClass('active-track');
        $(this).addClass('active-track');
        var activityId = $(this).data('id');
        var activityDate = $(this).data('date');
        var activeStreamPolyline = null;


        // --- Richiesta API /routes/{id}/streams ---
        $.ajax({
          url: "https://www.strava.com/api/v3/activities/"+activityId+"/streams",
          type: 'GET',
          data: {
            access_token: access_token, // token ottenuto da reAuthorize()
            keys: 'latlng,heartrate,time,velocity_smooth,altitude,grade_smooth',
            key_by_type: true
          },
          success: function(streams) {
            console.log(streams);
            if (!streams.heartrate && !streams.velocity_smooth) {
              $('#chart-container').html('<p class="text-warning">Nessun dato disponibile</p>');
              return;
            }
            


            
            // Rimuovi la polyline precedente se esiste
            if (activeStreamPolyline) {
              map.removeLayer(activeStreamPolyline);
            }
            
            var coordinate = streams.latlng.data
            activeStreamPolyline = L.polyline(coordinate, {
                color: 'blue',
                weight: 2,
                opacity: 0.7,
                lineJoin: 'round'
              }).addTo(map);


              
            polylines[activityId] = activeStreamPolyline;
            const times = streams.time.data;
            const heartrates = streams.heartrate ? streams.heartrate.data : [];
            const speeds = streams.velocity_smooth 
            ? streams.velocity_smooth.data.map(v => Math.round(v * 3.6)) // da m/s a km/h
            : [];
            const altitudes = streams.altitude ? streams.altitude.data : [];
            const distance = streams.distance ? streams.distance.data : [];
            const grade = streams.grade ? streams.grade.data : [];
            
            // Marker evidenziatore sulla mappa
            let highlightMarker = L.circleMarker([0,0], {
                radius: 6,
                color: '#ff0000',
                fillColor: '#ff0000',
                opacity: 0,
                fillOpacity: 0
                }).addTo(map);
                
            // Calcolo data/ora per ogni punto
            const startDateObj = new Date(activityDate);
            const pointDateTimes = times.map(sec => {
              let d = new Date(startDateObj.getTime() + sec * 1000);
              return d.toLocaleString('it-IT'); // formato leggibile es. 11/09/2025, 14:35:22
            });


      
            
            Highcharts.chart('chart-container', {
              chart: { type: 'spline',
                        zoomType: 'x',   // zoom solo sull’asse tempo
                        panning: true,
                        panKey: 'shift'  // tieni premuto Shift per muovere il grafico
              },
              title: { text: `${activityDate}` },
              xAxis: {
                categories: times.map(formatTime),
                title: { text: 'Tempo (hh:mm)' },
                tickInterval: 10
              },
              yAxis: [{
                title: { text: 'Frequenza cardiaca (BPM)' },
                min: 0
              }, {
                title: { text: 'Velocità (km/h)' },
                opposite: true,
                min: 0
              }, {
                title: { text: 'Altitudine (m)' },
                min: 0,
                gridLineDashStyle: 'Dash'
              },{
                title: { text: 'Pendenza (%)' },
                opposite: true,
                min: -20,
                max: 20
              }
          ],
                tooltip: {
                  shared: true,
                  crosshairs: true,
                  formatter: function () {
                    const index = this.points[0].point.index;
                    let s = `<b>${pointDateTimes[index]}</b><br/>`;

                    this.points.forEach(function (point) {
                      if (point.series.name === 'Frequenza cardiaca') {
                        s += `${point.series.name}: ${point.y} BPM<br/>`;
                      } else if (point.series.name === 'Velocità') {
                        s += `${point.series.name}: ${point.y} km/h<br/>`;
                      } else if (point.series.name === 'Altitudine') {
                        s += `${point.series.name}: ${point.y} m<br/>`;
                      }else if (point.series.name === 'Pendenza') {
                        s += `${point.series.name}: ${point.y} %<br/>`;
                      }
                    });
                    return s;
                  }
                },
              plotOptions: {
                series: {
                    point: {
                        events: {
                            mouseOver: function () {
                            const index = this.index;
                                if (selectedPolyline) {
                                const latlngs = coordinate;
                                    if (latlngs[index]) {
                                        highlightMarker.setLatLng(latlngs[index]);
                                        highlightMarker.setStyle({ opacity: 1, fillOpacity: 0.9 });
                                    }
                                }
                            },
                            mouseOut: function () {
                            highlightMarker.setStyle({ opacity: 0, fillOpacity: 0 });
                            }
                        }
                    }   
                }
                },
              series: [
                { name: 'Frequenza cardiaca', data: heartrates, yAxis: 0, color: '#e63946' },
                { name: 'Velocità', data: speeds, yAxis: 1, color: '#1d3557' },
                { name: 'Altitudine', data: altitudes, yAxis: 2, color: '#2a9d8f' },
                { name: 'Pendenza', data: grade, yAxis: 3, color: '#ff9900' }
              ],
              credits: { enabled: false }
            });
          },
          error: function(jqXHR, textStatus, errorThrown) {
            console.error("Errore API Strava streams:", textStatus, errorThrown);
            $('#chart-container').html('<p class="text-danger">Impossibile caricare i battiti cardiaci</p>');
          }
        });
    }
  });

  function reAuthorize() {
    $.ajax({
      type: 'POST',
      url: auth_link,
      data: {
        client_id: '170267',
        client_secret: '2a763ae8a5952c806420030f883b6d9c611c31a0',
        refresh_token: '1d09f95e93975a8d9d131e481b15b01ef63428b6',
        grant_type: 'refresh_token'
      }
    })
      .done(function (res) {
        access_token = res.access_token; // salvo il token globalmente
        getActivities(res, 1);        
      })
      .fail(function (jqXHR, textStatus, errorThrown) {
        console.error("Errore durante l'autenticazione:", textStatus, errorThrown);
        alert("Autenticazione fallita. Controlla le tue credenziali.");
      });
  }

  reAuthorize();
});


</script>
</body>
</html>
